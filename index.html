<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeightShare - Send or transport parcels with travellers</title>
  <style>
    :root {
      --bg: #f8fafc;
      --dark: #0b1220;
      --muted: #6b7280;
      --border: #e6eef8;
      --light-border: #f1f5f9;
      --blue: #2563eb;
      --green: #22c55e;
      --success: #16a34a;
      --error: #ef4444;
    }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      margin: 0;
      background-color: var(--bg);
      color: var(--dark);
      line-height: 1.5;
    }
    input, button, select, textarea {
      font-family: inherit;
      font-size: 100%;
      margin: 0;
      line-height: inherit;
    }
    a {
      color: var(--blue);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* Layout Containers */
    .container {
      max-width: 900px; /* Adjusted to fit your overall layout */
      margin-left: auto;
      margin-right: auto;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }

    /* Header */
    header {
      background-color: #fff;
      border-bottom: 1px solid var(--border);
      padding: 1rem 0; /* Adjusted for container padding */
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .nav-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-weight: 800;
      font-size: 1.25rem;
      color: var(--dark);
      text-decoration: none;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-weight: 600;
      font-size: 0.875rem;
      border-radius: 0.5rem;
      cursor: pointer;
      background-color: var(--blue);
      color: #fff;
      border: 1px solid var(--blue);
      transition: all 0.15s ease-in-out;
    }
    .btn:hover {
      background-color: #1e40af; /* Darker blue */
      border-color: #1e40af;
      text-decoration: none;
    }
    .btn.ghost {
      background-color: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn.ghost:hover {
      background-color: var(--light-border);
      color: var(--dark);
    }

    /* Hero Section */
    .hero {
      background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1572911475739-165c71a37c4e?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') center center / cover no-repeat;
      color: #fff;
      padding: 4rem 1.5rem 6rem; /* Increased bottom padding to accommodate search bar */
      text-align: center;
      min-height: 250px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .hero-title {
      font-size: 2.25rem;
      font-weight: 800;
      margin-bottom: 2rem;
      max-width: 600px;
      line-height: 1.2;
    }
    .search-bar {
      display: flex; /* Use flexbox for layout */
      background-color: #fff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      gap: 0.5rem;
      max-width: 900px; /* Matches container max-width */
      width: 100%;
      margin-top: -80px; /* Pulls it up into the hero section */
      position: relative;
      z-index: 10;
    }
    .search-bar .search-field {
      display: flex; /* For inner fields like from/to/date */
      flex: 1; /* Allows it to grow and shrink */
      gap: 0.5rem;
      align-items: center;
      min-width: 0; /* Allows flex items to shrink */
    }
    .search-bar .input,
    .search-bar .select,
    .search-bar .date {
      padding: 0.625rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      outline: none;
      transition: all 0.15s ease-in-out;
      width: 100%; /* Important for inputs inside wrapper */
      box-sizing: border-box; /* Include padding and border in width */
    }
    .search-bar .input:focus,
    .search-bar .select:focus,
    .search-bar .date:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    .search-bar .date {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
    }
    .search-bar .date::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      color: transparent;
      cursor: pointer;
    }
    .search-bar .date::-webkit-datetime-edit { display: inline-block; padding: 0; }
    .search-bar .date::placeholder { color: var(--muted); }
    
    .search-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.625rem 1rem;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      background-color: var(--blue);
      color: #fff;
      border: 1px solid var(--blue);
      transition: all 0.15s ease-in-out;
      white-space: nowrap;
    }
    .search-btn:hover {
      background-color: #1e40af; /* Darker blue */
      border-color: #1e40af;
    }

    /* Autocomplete specific styles */
    .autocomplete-wrapper {
      position: relative; /* CRITICAL: Establishes positioning context for children */
      flex: 1; /* Allows it to grow in a flex context, e.g., inside search-field */
      min-width: 0; /* Allows it to shrink in flex containers */
    }
    .suggestions-list {
      position: absolute; /* CRITICAL: Makes it float over other content */
      top: 100%; /* Position right below the input */
      left: 0;
      right: 0;
      background-color: #fff;
      border: 1px solid var(--border);
      border-top: none; /* Makes it look like it's connected to the input */
      border-radius: 0 0 8px 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      box-shadow: 0 4px 10px rgba(2,6,23,0.06);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100; /* Ensure it's above other elements like modals or other form fields */
      display: none; /* Hidden by default */
    }
    .suggestions-list li {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--dark);
      display: flex; /* Make li a flex container */
      justify-content: space-between; /* Space out name and country_name */
      align-items: center;
    }
    .suggestions-list li:hover,
    .suggestions-list li.active { /* 'active' class for keyboard navigation */
      background-color: var(--blue);
      color: #fff;
    }
    .suggestions-list li.active .muted-text {
      color: rgba(255,255,255,0.7); /* Muted text in active state */
    }
    .suggestions-list li .muted-text {
      color: var(--muted);
      font-size: 12px;
      margin-left: 8px;
      flex-shrink: 0; /* Prevent it from shrinking too much */
    }

    /* Main content area */
    main.container {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    .section-title {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--dark);
    }
    .date-group {
      margin-bottom: 1.5rem;
    }
    .date-header {
      font-weight: 700;
      font-size: 1.125rem;
      margin-bottom: 1rem;
      color: var(--dark);
    }
    .ticket {
      background-color: #fff;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
    }
    .ticket-left {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      flex: 1;
      min-width: 0;
      cursor: pointer;
      padding-right: 1rem; /* Space for price */
    }
    .ticket-left:focus {
      outline: 2px solid var(--blue);
      outline-offset: 2px;
      border-radius: 0.75rem;
    }
    .ticket-left .route {
      font-weight: 700;
      font-size: 1rem;
      color: var(--dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ticket-left .meta {
      font-size: 0.875rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .price {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--dark);
      margin-left: 1rem;
      white-space: nowrap;
    }
    .whatsapp-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      background-color: var(--green);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.15s ease-in-out;
      white-space: nowrap;
    }
    .whatsapp-btn:hover {
      background-color: #16a34a; /* Darker green */
    }
    .wa-icon {
      width: 18px;
      height: 18px;
    }
    .small-muted {
      font-size: 0.875rem;
      color: var(--muted);
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fade-in 0.2s ease-out;
    }
    .modal {
      background-color: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
      max-width: 500px;
      width: 90%;
      animation: zoom-in 0.2s ease-out;
      position: relative;
      z-index: 1001;
    }
    .modal h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      position: relative; /* CRITICAL for autocomplete in modal: Establishes positioning context */
    }
    .form-group label {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      outline: none;
      transition: all 0.15s ease-in-out;
      box-sizing: border-box; /* Crucial for consistent sizing */
      width: 100%; /* Ensure they take full width of their grid cell */
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    /* Toast Messages */
    .toast-root {
      position: fixed;
      bottom: 20px; /* Moved to bottom for better UX */
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center; /* Center toasts horizontally */
    }
    .toast {
      background-color: var(--success);
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slide-up 0.3s ease-out;
      width: fit-content; /* Only take content width */
      max-width: 90vw; /* Prevent from being too wide on small screens */
    }
    .toast.error {
      background-color: var(--error);
    }

    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes zoom-in {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 1.75rem;
      }
      .search-bar {
        flex-direction: column;
        margin-top: -60px;
        padding: 0.75rem; /* Ensure consistent padding */
      }
      .search-bar .search-field {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      .search-bar .search-field > *:not(.autocomplete-wrapper):not(.search-btn) {
          width: 100%;
      }
      .autocomplete-wrapper {
          width: 100%; /* Ensure autocomplete wrappers take full width */
      }
      .search-bar .select,
      .search-bar .input,
      .search-bar .date,
      .search-bar .search-btn {
          width: 100%;
      }

      .modal {
        width: 95%;
        padding: 1.5rem;
      }
      .form-grid {
        grid-template-columns: 1fr; /* Single column on small screens */
      }
      .form-group {
        width: 100%;
      }
      .ticket {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
      }
      .ticket-left {
        width: 100%;
        padding-right: 0;
        justify-content: space-between;
      }
      .ticket-left > div:first-child {
        min-width: unset;
        flex-grow: 1;
        overflow: hidden;
      }
      .ticket-left > div:last-child {
        flex-shrink: 0;
      }
      .price {
        margin-left: 0;
        width: 100%;
        text-align: right;
      }
      header .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      main.container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="container nav-wrap">
      <div class="logo">WeightShare</div>
      <div class="nav-actions">
        <button id="openAdd" class="btn">➕ Add Request</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-inner container">
      <div class="hero-title">Send or transport parcels with travellers — faster and cheaper</div>

      <form id="searchForm" class="search-bar" role="search" aria-label="Search transport requests">
        <div class="autocomplete-wrapper" style="min-width:200px;max-width:260px;">
          <select id="searchType" class="select" aria-label="Request type">
            <option value="">Any type</option>
            <option value="shipper">Shipper (looking to send)</option>
            <option value="traveller">Traveller (offering transport)</option>
          </select>
        </div>

        <div class="search-field">
          <div class="autocomplete-wrapper">
            <input id="searchFrom" class="input" type="text" placeholder="Leaving from (city or country)" aria-label="From" autocomplete="off" />
            <ul id="suggestionsSearchFrom" class="suggestions-list"></ul>
            <input type="hidden" id="searchFrom_cc" name="from_country" />
            <input type="hidden" id="searchFrom_type" name="from_type" />
          </div>

          <div class="autocomplete-wrapper">
            <input id="searchTo" class="input" type="text" placeholder="Going to (city or country)" aria-label="To" autocomplete="off" />
            <ul id="suggestionsSearchTo" class="suggestions-list"></ul>
            <input type="hidden" id="searchTo_cc" name="to_country" />
            <input type="hidden" id="searchTo_type" name="to_type" />
          </div>

          <input
            id="searchDate"
            class="date"
            type="date"
            placeholder="When"
            aria-label="Date"
          />
          <script>
            /* If on mobile, switch to text mode initially so placeholder is visible */
            if (window.innerWidth <= 720) {
              const d = document.getElementById('searchDate');
              d.type = 'text';
              d.addEventListener('focus', function(){ this.type='date'; });
              d.addEventListener('blur', function(){ if(!this.value) this.type='text'; });
            }
          </script>
        </div>

        <div>
          <button id="doSearch" class="search-btn">Search</button>
        </div>
      </form>
    </div>
  </section>

  <main class="container">
    <h3 class="section-title">Open Requests</h3>
    <div id="resultsRoot" aria-live="polite">
    </div>
  </main>

  <div id="modalRoot" style="display:none"></div>
  <div id="successRoot" style="display:none"></div>
  <div id="toastRoot" class="toast-root"></div>

  <script>
    /* --- CONFIG --- */
    const WORKER_URL = 'https://weightshare-backend.weightshare.workers.dev'; // <<< IMPORTANT: Update with YOUR actual deployed Worker URL!
    const LIST_ROUTE = '/list';
    const ADD_ROUTE = '/add-request';
    const CLOSE_ROUTE = '/close-request';
    const SEARCH_LOCATIONS_ROUTE = '/search-locations'; // New route for location search

    // State to store selected location details (value, country code, type) for both search and add forms
    let searchState = {
      from: { val: '', cc: '', type: '' }, // For search form 'from'
      to:   { val: '', cc: '', type: '' }, // For search form 'to'
      addFrom: { val: '', cc: '', type: '' }, // For add form 'from'
      addTo:   { val: '', cc: '', type: '' }  // For add form 'to'
    };

    /* --- API HELPERS --- */
    const api = {
      async list(q = {}) {
        const params = new URLSearchParams();
        if (q.from) params.set('from', q.from);
        if (q.to) params.set('to', q.to);
        if (q.datepickup) params.set('datepickup', q.datepickup);
        if (q.type) params.set('type', q.type);
        if (q.from_country) params.set('from_country', q.from_country);
        if (q.from_type) params.set('from_type', q.from_type);
        if (q.to_country) params.set('to_country', q.to_country);
        if (q.to_type) params.set('to_type', q.to_type);
        
        const url = WORKER_URL + LIST_ROUTE + (params.toString() ? ('?' + params.toString()) : '');
        try {
          const r = await fetch(url);
          if (!r.ok) {
            const errorText = await r.text();
            console.error(`API Error (list): ${r.statusText} (${r.status}) - ${errorText}`);
            return { status: 'error', message: `Server error: ${r.statusText}` };
          }
          return await r.json();
        } catch (e) {
          console.error("API Error (list):", e);
          return { status: 'error', message: String(e) };
        }
      },
      async add(payload) {
        try {
          const r = await fetch(WORKER_URL + ADD_ROUTE, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: 'Unknown error' }));
            console.error(`API Error (add): ${r.statusText} (${r.status}) - ${errorData.message}`);
            return { status:'error', message: errorData.message || `Server error: ${r.statusText}` };
          }
          return await r.json();
        } catch (e) {
          console.error("API Error (add):", e);
          return { status:'error', message:String(e) };
        }
      },
      async close(id) {
        try {
          const r = await fetch(WORKER_URL + CLOSE_ROUTE, {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id })
          });
          if (!r.ok) {
            const errorText = await r.text();
            console.error(`API Error (close): ${r.statusText} (${r.status}) - ${errorText}`);
            return { status:'error', message: `Server error: ${r.statusText}` };
          }
          return await r.json();
        } catch (e) {
          console.error("API Error (close):", e);
          return { status:'error', message:String(e) };
        }
      },
      async searchLocations(query) {
        if (!query) return [];
        // Ensure the query parameter name matches your backend (q=)
        const params = new URLSearchParams({ q: query }); 
        const url = WORKER_URL + SEARCH_LOCATIONS_ROUTE + '?' + params.toString();
        try {
          const r = await fetch(url);
          if (!r.ok) {
              const errorText = await r.text();
              console.error(`Location search failed: ${r.statusText} (${r.status}) - ${errorText}`);
              return [];
          }
          return await r.json();
        } catch (e) {
          console.error("API Error (searchLocations):", e);
          return [];
        }
      }
    };

    /* --- UI HELPERS --- */
    function showToast(text, {auto=2200, background='var(--success)', type='success'}={}) {
      const root = document.getElementById('toastRoot');
      const toastElement = document.createElement('div');
      toastElement.className = `toast ${type}`;
      toastElement.style.background = background;
      toastElement.textContent = text;
      root.appendChild(toastElement);

      if (auto > 0) {
        setTimeout(() => {
          toastElement.remove(); // Remove the specific toast
        }, auto);
      }
    }

    function showSuccessModal(id) {
      const root = document.getElementById('successRoot');
      root.style.display = 'block';
      root.innerHTML = `
        <div class="modal-backdrop success-modal" role="dialog" aria-modal="true">
          <div class="modal">
            <h3 style="margin-top:0;color:var(--success)">✔ Request created</h3>
            <p style="margin:8px 0 14px">Your request was submitted successfully. Save this ID to close the request later.</p>
            <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px">
              <div style="background:#fff;padding:10px 14px;border-radius:8px;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.04)">${id}</div>
              <button id="copyId" class="btn ghost copy-btn">Copy ID</button>
            </div>
            <div style="display:flex;justify-content:center;gap:8px">
              <button id="closeSuccess" class="btn ghost">Close</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('copyId').addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(id);
          showToast('ID copied to clipboard', {auto:1600});
        } catch (e) {
          showToast('Could not copy', {auto:1600, background: 'var(--error)', type:'error'});
        }
      });
      document.getElementById('closeSuccess').addEventListener('click', ()=>{
        root.style.display = 'none';
        root.innerHTML = '';
      });
    }

    function cleanPhoneForWa(phone) {
      if (!phone) return '';
      let p = phone.toString().trim();
      p = p.replace(/\s+/g,'');
      p = p.replace(/[^\d]/g,'');
      return p;
    }

    function groupByDate(items){
      const map = {};
      items.forEach(it=>{
        const dp = it.datepickup || it.datepickup_clean
        ? new Date(it.datepickup || it.datepickup_clean).toISOString().slice(0,10)
        : 'no-date';
        if (!map[dp]) map[dp]=[];
        map[dp].push(it);
      });
      const sortedKeys = Object.keys(map).sort();
      const ordered = {};
      sortedKeys.forEach(k=>ordered[k]=map[k]);
      return ordered;
    }

    function renderGrouped(list){
      const root = document
